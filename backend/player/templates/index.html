<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="#" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/fontawesome.min.css" />
    <link href="https://vjs.zencdn.net/7.11.4/video-js.css" rel="stylesheet" />

    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #1c1c1c;
        color: #ccc;
        margin: 0;
        padding: 0;
      }
    
      .container {
        max-width: 960px;
        margin: 0 auto;
        padding: 20px;
      }
    
      h1, h2, h3, h4, h5, h6 {
        font-weight: normal;
        margin: 0;
        padding: 0;
        color: #ccc;
      }
    
      h3 {
        margin-bottom: 10px;
      }
    
      video-js {
        display: block;
        margin-bottom: 20px;
      }
    
      .buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
    
      button {
        background-color: #bba35c;
        color: #fff;
        border: 2px solid #ddc588;
        padding: 10px 20px;
        cursor: pointer;
        font-size: 16px;
        border-radius: 5px;
        text-transform: uppercase;
        transition: background-color 0.3s, border-color 0.3s;
      }
    
      button:hover {
        background-color: #ddc588;
        border-color: #f0deaf;
      }

      button:active {
        transform: scale(0.95);
        opacity: 0.8;
      }

      .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 10px;
      }

      .songlist, .token {
        margin-bottom: 20px;
      }

      .info-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;
      }
      
      .info-item {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .info-label {
        font-weight: bold;
        color: #bba35c;
      }
      
      .info-value {
        color: #ccc;
      }

      /* Player layout */
      .video-container {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
        margin-bottom: 20px;
      }
      
      .video-js {
        border: 4px solid #bba35c;
        border-radius: 10px;
      }

      /* Dashboard layout */
      .dashboard {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-gap: 20px;
      }
    
      .left-section {
        background-color: #333;
        border-radius: 5px;
        padding: 20px;
      }

      .right-section {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      
      .section-title {
        color: #bba35c;
        border-bottom: 1px solid #bba35c;
        padding-bottom: 10px;
        margin-bottom: 10px;
      }
      
      .section-content {
        background-color: rgba(187, 163, 92, 0.1);
        padding: 15px;
        border-radius: 10px;
        color: #ccc;
      }

      .jwt-container {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .session-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .session-button {
        flex-grow: 1;
        text-align: center;
      }

      /* Scrollable song list */
      .songlist {
        max-height: 300px;
        overflow-y: auto;
      }
    </style>

    <meta name="google-signin-scope" content="profile email">
    <meta name="google-signin-client_id" content="376808175534-d6mefo6b1kqih3grjjose2euree2g3cs.apps.googleusercontent.com">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <div id="g_id_onload" data-client_id="376808175534-d6mefo6b1kqih3grjjose2euree2g3cs.apps.googleusercontent.com" data-callback="get_jwt_using_google_credential" data-auto_prompt="false" />


  </head>

  </head>

  <body>

    <div class="container">
      <div class="video-container">
        <video-js
          id="video"
          class="video-js"
          controls
          preload="auto"
          width="900"
          height="550"
          autoplay="true"
          data-setup="{}"
        ></video-js>
      </div>
    
      <div class="info-container section-content">
        <div class="info-item">
          <span class="info-label">Title:</span>
          <span class="info-value" id="title"></span>
        </div>
        <div class="info-item">
          <span class="info-label">URL:</span>
          <span class="info-value" id="url"></span>
        </div>
        <div class="info-item">
          <span class="info-label">Duration:</span>
          <span class="info-value" id="duration"></span>
        </div>
        <div class="info-item">
          <span class="info-label">User:</span>
          <span class="info-value" id="user"></span>
        </div>
      </div>

      <div class="dashboard">
        <div class="left-section">
          <!-- Put the video player and buttons here -->

          <div class="button-group">
            <button onclick="play()">Play</button>
            <button onclick="pause()">Pause</button>
            <button onclick="mute()">Mute</button>
            <button onclick="unmute()">Unmute</button>
          </div>
        
          <div class="button-group">
            <button onclick="cut()">Cut</button>
            <button onclick="cut_and_block()">Cut & Block</button>
            <button onclick="favorite()">Favorite</button>
            <button onclick="unfavorite()">Unfavorite</button>
          </div>
        
          <div class="button-group">
            <button onclick="load_song_list()">Reload Song List</button>
          </div>
        </div>

        <div class="right-section">
          <h3 class="section-title">Song List</h3>
          <div id="songlist" class="section-content"></div>
        
          <h3 class="section-title">JWT</h3>
          <div class="jwt-container">
            <div id="token" class="section-content"></div>
            <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left"></div>
          </div>
          <button onclick=logout()>JWT Logout</button>

          <h3 class="section-title">Session</h3>
          <div class="session-container">
            <button class="session-button" onclick="javascript:location.href='/api/__hidden_admin/'">Login</button>
            <button class="session-button" onclick="javascript:location.href='/api/__hidden_admin/logout/'">Logout</button>
          </div>
        

      </div>
    </div>

    <script src="https://code.jquery.com/jquery-2.1.1.min.js" type="text/javascript"></script>
    <script src="https://vjs.zencdn.net/7.11.4/video.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>

      // ----------------------------------------------

      // 3rd-party login

      function get_jwt_using_google_credential(data) {
        $.post("/api/auth/google/token", {credential: data.credential}, function(response) {
          localStorage.setItem("access_token", response.access_token);
          localStorage.setItem("refresh_token", response.refresh_token);
          console.log("Google Login");
      
          $.ajax({
            type: "POST",
            url: "/api/auth/token/verify",
            data: {token: response.access_token},
            headers: {
              "Authorization": "Bearer " + response.access_token
            },
            success: function(data) {
              console.log(data);
              location.reload();
            },
            error: function(data) {
              console.log(data);
            }
          });
        });
      }

      // ----------------------------------------------

      // Logout

      function logout() {
        localStorage.removeItem("refresh_token");
        localStorage.removeItem("access_token");
        location.href = "/player/";
        location.reload();
      }


      // ----------------------------------------------

      // JWT

      function get_jwt_token_and_refresh() {
        return {
          token: localStorage.getItem("access_token"),
          refresh: localStorage.getItem("refresh_token")
        };
      }
      
      function get_auth_headers() {
        return {
          Authorization: "Bearer " + get_jwt_token_and_refresh().token
        };
      }
      
      function handle_jwt_error(data, errorType) {
        Swal.fire({ icon: 'error', title: `JWT ${errorType} Error`, text: data.responseText });
        const msg = `JWT ${errorType} Error: ` + data.responseText;
        console.log(msg);
        $("#token").text(msg).css("color", "red");
      }
      
      function jwt_refresh_and_verify() {
        console.log("--- JWT Refresh and Verify ---");
        const { token, refresh } = get_jwt_token_and_refresh();
      
        if (token) {
          $.ajax({
            type: "POST",
            url: "/api/auth/token/refresh",
            data: { refresh },
            success(data) {
              localStorage.setItem("token", data.access_token);
              const jwt_token = data.access_token;
              $.ajax({
                type: "POST",
                url: "/api/auth/token/verify",
                data: { token: jwt_token },
                headers: { Authorization: "Bearer " + jwt_token },
                success(data) {
                  const msg = "Login with JWT token!";
                  console.log(msg);
                  $("#token").text(msg).css("color", "green");
                },
                error(data) {
                  handle_jwt_error(data, 'Verify');
                }
              });
            },
            error(data) {
              handle_jwt_error(data, 'Refresh');
            }
          });
        } else {
          Swal.fire({ icon: 'question', title: 'Login', text: 'Please login!' });
          const msg = "Have not login with JWT token!";
          $("#token").text(msg).css("color", "red");
          console.log(msg);
        }
        console.log("----------------------------");
      }

      // ----------------------------------------------

      /*
      // polling 暫放區
      // TODO 偵測當前投票數量是否卡歌（沒websocket的做法）
      var sleep = duration => new Promise(resolve => setTimeout(resolve, duration))
      var poll = (promiseFn, duration) => promiseFn().then(
                   sleep(duration).then(() => poll(promiseFn, duration)))
      
      // Greet the World every second
      poll(() => new Promise(() => console.log('Hello World!')), 3000)
      */

      var now_playing_id = 0;

      function play() {
        var videoPlayer = videojs("video");
        videoPlayer.play();
      }
      function pause() {
        var videoPlayer = videojs("video");
        videoPlayer.pause();
      }
      function mute() {
        var videoPlayer = videojs("video");
        videoPlayer.muted(true);
      }
      function unmute() {
        var videoPlayer = videojs("video");
        videoPlayer.muted(false);
      }
      function insert_song_signal(playing_id, order) {
        console.log(`指定播放順序，佇列ID：` + playing_id);
        $.ajax({
          type: "GET",
          dataType: "json",
          headers: get_auth_headers(),
          url: `playlist/${playing_id}/insert?order=${order}`,
          success(res) {
            console.log(res);
          }
        });
      }
      function favorite_song(playing_id) {
        console.log(`將歌曲加入收藏，佇列ID：` + playing_id);
        $.ajax({
          type: "GET",
          dataType: "json",
          headers: get_auth_headers(),
          url: `playlist/${playing_id}/mark?favorite=true`,
          success(res) {
            console.log(res);
          }
        });
      }
      
      function unfavorite_song(playing_id) {
        console.log(`將歌曲解除收藏，佇列ID：` + playing_id);
        $.ajax({
          type: "GET",
          dataType: "json",
          headers: get_auth_headers(),
          url: `playlist/${playing_id}/mark?favorite=false`,
          success(res) {
            console.log(res);
          }
        });
      }
      
      function cut_song_signal() {
        if (now_playing_id !== 0) {
          console.log(`沒播完，直接卡掉，移除佇列ID：` + now_playing_id);
          $.ajax({
            type: "GET",
            dataType: "json",
            headers: get_auth_headers(),
            url: `playlist/${now_playing_id}/mark?cut=true&delete=true`,
            success(res) {
              console.log(res);
              now_playing_id = 0;
            }
          });
        }
      }
      
      function cut_and_block_song_signal() {
        if (now_playing_id !== 0) {
          console.log(`沒播完，直接卡掉並加入黑名單，移除佇列ID：` + now_playing_id);
          $.ajax({
            type: "GET",
            dataType: "json",
            headers: get_auth_headers(),
            url: `playlist/${now_playing_id}/mark?cut=true&delete=true&block=true`,
            success(res) {
              console.log(res);
              now_playing_id = 0;
            }
          });
        }
      }

      function favorite_song_signal() {
        if (now_playing_id != 0) {
          favorite_song(now_playing_id);
        }
      }

      function unfavorite_song_signal() {
        if (now_playing_id != 0) {
          unfavorite_song(now_playing_id);
        }
      }

      function cut() {
        cut_song_signal();
        location.reload();
      }

      function cut_and_block() {
        cut_and_block_song_signal();
        location.reload();
      }

      function favorite() {
        favorite_song_signal();
      }

      function unfavorite() {
        unfavorite_song_signal();
      }

      function load_song_list() {
        $.ajax({
          type: "GET",
          dataType: "json",
          headers: get_auth_headers(),
          url: "playlist/queue",
          success(queue) {
            const html = render_song_list(queue);
            document.getElementById("songlist").innerHTML = html;
          }
        });
      }
      
      function insert_song_to_top(playing_id) {
        console.log(`指定播放順序，佇列ID：` + playing_id);
        $.ajax({
          type: "GET",
          dataType: "json",
          headers: get_auth_headers(),
          url: `playlist/${playing_id}/insert?order=1`,
          success(res) {
            console.log(res);
            console.log("Reload playlist!");
            load_song_list();
          }
        });
      }
      
      function delete_song_in_queue(playing_id) {
        console.log(`刪除佇列ID：` + playing_id);
        $.ajax({
          type: "GET",
          dataType: "json",
          headers: get_auth_headers(),
          url: `playlist/${playing_id}/delete`,
          success(res) {
            console.log(res);
            console.log("Reload playlist!");
            load_song_list();
          }
        });
      }
      
      function delete_and_block_song(playing_id) {
        console.log(`還沒播，直接刪掉並加入黑名單，移除佇列ID：` + playing_id);
        $.ajax({
          type: "GET",
          dataType: "json",
          headers: get_auth_headers(),
          url: `playlist/${playing_id}/delete`,
          success(res) {
            console.log(res);
            $.ajax({
              type: "GET",
              dataType: "json",
              headers: get_auth_headers(),
              url: `playlist/${playing_id}/mark?cut=true&delete=true&block=true`,
              success(res) {
                console.log(res);
                console.log("Reload playlist!");
                load_song_list();
              }
            });
          }
        });
      }

      function create_styled_button(text, onClickFunction, id) {
        return `<button class="custom-button" onclick="${onClickFunction}(${id})">${text}</button>`;
      }

      function render_song_list(queue) {
        let html = "";
        queue.forEach((res) => {
          const { order, id, song_name, user, url } = res;
      
          html += order === 1 ? "第一首歌 #" + order + "<br>" : "點歌順序#" + order + "<br>";
          html += `
          <div class="song-info">
            <div class="section-content">
              <div class="song-id">記錄 #${id}</div>
              <div class="song-title">歌名：${song_name}</div>
              <div class="song-user">點歌者：${user}</div>
              <button class="copy-url-btn" onclick=navigator.clipboard.writeText("${url}")>Copy URL</button>
          `;

            if (order !== 1) {
              html += '<br>';
              html += create_styled_button("插歌", "insert_song_to_top", id);
              html += create_styled_button("加最愛", "favorite_song", id);
              html += create_styled_button("移除最愛", "unfavorite_song", id);
              html += create_styled_button("刪歌", "delete_song_in_queue", id);
              html += create_styled_button("刪歌拉黑單", "delete_and_block_song", id);
          }

        html += `</div></div>`;
      
        html += order === 1 ? "<h3>------------------------</h3><br>" : "<br>";
        });
        return html;
      }

      function get_player_volume() {
        var volume = window.localStorage.getItem("player-volume");
        if (!volume) {
          volume = 0.003;
        }
        return volume;
      }

      function set_player_volume(volume) {
        var videoPlayer = videojs("video");
        videoPlayer.volume(volume);
      }

      function get_video_url_and_play(videoPlayer, url, new_id, user, song_name) {
        $.ajax({
          type: "GET",
          headers: get_auth_headers(),
          url: `youtube-video-info?url=${url}`,
          success: function (res) {
            now_playing_id = new_id;
            videoPlayer.src({
              type: "video/mp4",
              src: res.video_url,
            });
            $("#user").text(user);
            $("#title").text(res.title);
            $("#url").text(url);
            $("#duration").text(res.duration);
            console.log("已獲得此歌曲的播放網址");
            console.log(res);
            // 更新底下播放清單
            load_song_list();
            console.log(`------------------------------------`);
          },
          error: function (err) {
            console.log(err);
          },
        });
      }

      function set_playlist(videoPlayer) {
        $.ajax({
          type: "GET",
          dataType: "json",
          headers: get_auth_headers(),
          url: "playlist/get",
          success: function (playlist) {
            if (playlist.length === 0) {
              console.log(`------------------------------------`);
              console.log(`播放清單已經爲空！`);
              console.log(`------------------------------------`);
              return;
            }
      
            const { id: new_id, user, in_queue, song_name, url } = playlist[0];
      
            console.log(`------------------------------------`);
            console.log(`播放器音量： ${videoPlayer.volume()}`);
            console.log(`點播者： ${user}`);
            console.log(`歌名： ${song_name}`);
            console.log(`URL： ${url}`);
            console.log(`此ID是否於佇列中（自動點播爲False）： ${in_queue}`);
            console.log(`播放ID轉換： ${now_playing_id} -> ${new_id}`);
            console.log(`------------------------------------`);
      
            get_video_url_and_play(videoPlayer, url, new_id, user, song_name);
      
          },
          error: function (err) {
            console.log(err);
          },
        });
      }

      function check_and_set_playlist(videoPlayer) {
        if (now_playing_id != 0) {
          console.log(`播放完畢，移除佇列ID：${now_playing_id}`);
          $.ajax({
            type: "GET",
            dataType: "json",
            headers: get_auth_headers(),
            url: `playlist/${now_playing_id}/mark?played=true&delete=true`,
            success: (res) => {
              console.log(res);
              set_playlist(videoPlayer);
            },
          });
        } else {
          set_playlist(videoPlayer);
        }
      }

      function change_player_src() {
        const videoPlayer = videojs("video").ready(function () {
          const player = this;
          // 設定播放器音量
          const volume = get_player_volume();
          player.volume(volume);
          // 設定播放器結束事件
          player.on("ended", () => {
            check_and_set_playlist(player);
          });
          // 設定播放器音量控制事件
          player.on("volumechange", () => {
            window.localStorage.setItem("player-volume", player.volume());
          });
          // 設定播放器遇到ERROR處理
          player.reloadSourceOnError({
            getSource: function (reload) {
              console.log("Reloading because of an error");
              console.log("Set now playing ID to 0 -> reload playlist!");
              now_playing_id = 0;
              location.reload();
            },
            errorInterval: 5,
          });
          check_and_set_playlist(player);
        });
      }

      // -------------------------

      $(document).ready(function () {
        $.when(jwt_refresh_and_verify()).then(function(){change_player_src();})
      });

    </script>

  </body>
</html>
