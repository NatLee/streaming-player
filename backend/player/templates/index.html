{% load bootstrap3 %}
<html>
  <head>
    <link rel="shortcut icon" href="#" />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/fontawesome.min.css"
    />
    <link href="https://vjs.zencdn.net/7.11.4/video-js.css" rel="stylesheet" />

    {% bootstrap_css %}
  </head>

  <body>
    <video-js
      id="video"
      class="video-js"
      controls
      preload="auto"
      width="640"
      height="390"
      autoplay="true"
      data-setup="{}"
    ></video-js>

    <br /><br />

    <div id="title"></div>
    <div id="url"></div>
    <div id="duration"></div>
    <div id="user"></div>

    <br /><br />

    <button onclick="play()">Play</button>
    <button onclick="pause()">Pause</button>
    <button onclick="mute()">Mute</button>
    <button onclick="unmute()">Unmute</button>
    <button onclick="cut()">Cut</button>

    <br /><br />

    <button onclick="load_song_list()">Reload Song List</button>

    <br /><br />

    <h3>初次訪問此頁面要點擊播放之後的影片才會自動播放</h3>

    <h3>---- Song List ----</h3>

    <br />

    <div id="songlist"></div>

    <script
      src="https://code.jquery.com/jquery-2.1.1.min.js"
      type="text/javascript"
    ></script>
    <script src="https://vjs.zencdn.net/7.11.4/video.min.js"></script>

    {% bootstrap_javascript %}

    <script>
      var now_playing_id = 0;

      function cut_song_signal() {
        if (now_playing_id != 0) {
          console.log(`沒播完，直接卡掉，移除佇列ID：` + now_playing_id);
          $.ajax({
            type: "GET",
            dataType: "json",
            url: "playlist/" + now_playing_id + "/mark?cut=true",
            success: function (res) {
              console.log(res);
              now_playing_id = 0;
            },
          });
        }
      }

      function play() {
        var videoPlayer = videojs("video");
        videoPlayer.play();
      }
      function pause() {
        var videoPlayer = videojs("video");
        videoPlayer.pause();
      }
      function mute() {
        var videoPlayer = videojs("video");
        videoPlayer.muted(true);
      }
      function unmute() {
        var videoPlayer = videojs("video");
        videoPlayer.muted(false);
      }

      function cut() {
        cut_song_signal();
        location.reload();
      }
      function load_song_list() {
        $.ajax({
          type: "GET",
          dataType: "json",
          url: "playlist/queue",
          success: function (queue) {
            html = "";
            queue.forEach(function (res) {
              html +=
                res.order +
                "<br>" +
                res.song_name +
                "<br>" +
                res.user +
                "<br>" +
                res.url +
                "<br><br><br>";
            });
            document.getElementById("songlist").innerHTML = html;
          },
        });
      }

      function get_player_volume() {
        var volume = window.localStorage.getItem("player-volume");
        if (!volume) {
          volume = 0.003;
        }
        return volume;
      }

      function set_player_volume(volume) {
        var videoPlayer = videojs("video");
        videoPlayer.volume(volume);
      }

      function set_playlist(videoPlayer) {
        $.ajax({
          type: "GET",
          dataType: "json",
          url: "playlist/get",
          success: function (playlist) {
            new_id = playlist[0].id;
            user = playlist[0].user;
            in_queue = playlist[0].in_queue;
            url = playlist[0].url;
            console.log(`------------------------------------`);
            console.log(`播放器音量：` + videoPlayer.volume());
            console.log(`點播者： ` + user);
            console.log(`此ID是否於佇列中： ` + in_queue);
            console.log(`播放ID轉換： ` + now_playing_id + ` -> ` + new_id);
            console.log(`------------------------------------`);
            $.ajax({
              type: "GET",
              url: "youtube-video-info?url=" + url,
              success: function (res) {
                now_playing_id = new_id;
                videoPlayer.src({
                  type: "video/mp4",
                  src: res.video_url,
                });
                $("#user").text(user);
                $("#title").text(res.title);
                $("#url").text(res.url);
                $("#duration").text(res.duration);
                console.log("Get new video");
                console.log(res);
              },
              error: function (err) {
                console.log(err);
              },
            });
          },
          error: function (err) {
            console.log(err);
          },
        });
      }

      function check_and_set_playlist(videoPlayer) {
        if (now_playing_id != 0) {
          console.log(`播放完畢，移除佇列ID：` + now_playing_id);
          $.ajax({
            type: "GET",
            dataType: "json",
            url: "playlist/" + now_playing_id + "/mark?played=true",
            success: function (res) {
              console.log(res);
              set_playlist(videoPlayer);
            },
          });
        } else {
          set_playlist(videoPlayer);
        }
      }

      function change_player_src() {
        // 更新底下播放清單
        load_song_list();

        var videoPlayer = videojs("video").ready(function () {
          var player = this;
          // 設定播放器音量
          player.volume(get_player_volume());
          // 設定播放器結束事件
          player.on("ended", () => {
            check_and_set_playlist(player);
          });
          // 設定播放器音量控制事件
          player.on("volumechange", () => {
            window.localStorage.setItem("player-volume", player.volume());
          });
          // 設定播放器遇到ERROR處理
          player.reloadSourceOnError({
            getSource: function (reload) {
              console.log("Reloading because of an error");
              console.log("Set now playing ID to 0 -> reload playlist!");
              now_playing_id = 0;
              change_player_src(player);
            },
            errorInterval: 5,
          });
          // 檢查並設定播放
          check_and_set_playlist(player);
        });
      }

      $(document).ready(function () {
        change_player_src();
      });
    </script>
  </body>
</html>
